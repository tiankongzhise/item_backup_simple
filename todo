一、项目背景

当前有一个文件备份系统，用于将本地文件和文件夹备份到百度网盘，但当前版本存在以下问题：

批处理模式导致大量文件同时压缩和解压，消耗大量硬盘空间

百度网盘分片上传进一步加剧了磁盘空间紧张

空间管理不足，可能超过硬盘容量
二、重构目标

将批处理流程改为单文件处理模式，并优化资源管理：

核心优化点：

流程重构：从批处理改为单文件序列化处理

空间控制：动态监控磁盘使用，设置80G空间阈值

异步上传：上传与本地处理解耦

路径标准化：统一本地和云端存储结构

三、详细流程设计
3.1 单文件处理流程（同步阶段）
1. 源文件扫描 → 数据库比对 → 文件分类计算 → 源文件Hash计算
   ↓
2. 压缩处理 → 压缩包Hash计算 → 解压验证
   ↓
3. 验证通过 → 删除解压文件 → 进入上传队列
   ↓
4. 异步上传 → 上传成功回调 → 数据库更新 → 删除源文件和压缩包

3.2 存储路径规范
config指定目录/YYYYMMDD/源文件夹名/加密密码/文件名.zip
程序指定目录/YYYYMMDD/源文件夹名/加密密码/文件名.zip

3.3 资源管理策略
3.3.1 磁盘空间管理

监控阈值：总使用量不超过80GB

动态控制：

计算下一个待处理文件所需空间

如果剩余空间不足，等待已上传任务释放空间

空间释放后检查是否满足下一个文件需求

3.3.2 各阶段空间占用估算

阶段1：源文件Hash计算    占用：文件大小
阶段2：压缩处理         占用：文件大小 + 压缩包大小
阶段3：解压验证         占用：文件大小 + 压缩包大小 + 解压文件大小
阶段4：验证完成         占用：压缩包大小
阶段5：上传完成         占用：0

3.4 异步上传机制

上传任务放入队列，后台线程处理

上传完成触发回调函数

回调处理：更新数据库 + 清理本地文件

支持失败重试和断点续传

四、系统组件设计
4.1 核心模块

4.2 控制流程

while True:
    # 1. 检查磁盘空间
    if disk_used < 80GB - next_file_required_space:
        # 2. 获取下一个待处理文件
        next_file = file_queue.get()
        
        if not next_file:
            break

        # 3. 计算所需空间
        required_space = calculate_required_space(next_file)
        
        # 4. 预留空间，开始处理
        with space_reservation(required_space):
            process_single_file(next_file)
            
        # 5. 文件进入上传队列
        upload_queue.put(processed_file)
    else:
        # 等待空间释放
        wait_for_space()
        
    # 6. 后台上传线程处理上传队列
    process_upload_queue_async()

五、错误处理和恢复
5.1 异常处理

压缩失败：重试3次后标记为失败

验证失败：删除压缩包，重新压缩

上传失败：加入重试队列，最多重试5次

空间不足：暂停处理，等待空间释放

5.2 恢复机制

定期检查未完成的任务

记录各阶段状态，支持断点续做

清理僵尸进程和临时文件

六、监控和日志
6.1 监控指标

当前磁盘使用量

待处理文件队列长度

上传队列长度

各阶段处理时间

成功率/失败率

6.2 日志记录

每个文件的完整处理轨迹

空间使用情况变化

异常和错误详情

性能统计信息

八、部署建议
8.1 性能优化

设置合理的并发数（建议1-2个文件同时处理）

压缩级别根据文件类型调整

上传分片大小根据网络状况调整

定期清理临时文件和日志